name: Update Production

on:
    push:
        branches: [master]

jobs:
    update-production:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v2

            - uses: actions/setup-node@v2
              with:
                  node-version: '16'

            - name: Checkout repository and submodules
              uses: actions/checkout@v2
              with:
                  token: ${{ secrets.MEDIA_KEY }}
                  submodules: recursive

            - name: Installing
              run: npm install

            - name: Build
              run: npm run build

            - name: Push static content to CDN
              uses: nebula-dev/spaces-sync-action@master
              env:
                  SOURCE_DIR: './client/'
                  SPACE_REGION: 'nyc3'
                  SPACE_NAME: ${{ secrets.SPACE_NAME }}
                  SPACE_ACCESS_KEY: ${{ secrets.SPACE_ACCESS_KEY }}
                  SPACE_SECRET_KEY: ${{ secrets.SPACE_SECRET_KEY }}

            - name: Push play page to CDN
              uses: nebula-dev/spaces-sync-action@master
              env:
                  SOURCE_DIR: './play/'
                  SPACE_REGION: 'nyc3'
                  SPACE_NAME: ${{ secrets.SPACE_NAME }}
                  SPACE_ACCESS_KEY: ${{ secrets.SPACE_ACCESS_KEY }}
                  SPACE_SECRET_KEY: ${{ secrets.SPACE_SECRET_KEY }}

    create-archive:
        runs-on: ubuntu-latest

        steps:
            - name: Install zip
              uses: montudor/action-zip@v1

            - name: Checkout repository and submodules
              uses: actions/checkout@v2
              with:
                  token: ${{ secrets.MEDIA_KEY }}
                  submodules: recursive
                  path: client

            - name: Remove .git folder to reduce file size
              run: rm -rf client/.git

            - name: Checkout server
              uses: actions/checkout@v2
              with:
                  repository: Club-Penguin-Plus-Official/server
                  token: ${{ secrets.MEDIA_KEY }}
                  path: server

            - name: Get version
              id: package-version
              uses: martinbeentjes/npm-get-version-action@main
              with:
                  path: 'client'

            - name: Create archive folder
              run: mkdir -p archive

            - name: Zip files
              run: zip -qq -r archive/${{ steps.package-version.outputs.current-version }}.zip server client

            - name: Upload archive
              uses: Club-Penguin-Plus-Official/spaces-sync-action@archive
              env:
                  SOURCE_DIR: './archive/'
                  SPACE_REGION: 'nyc3'
                  SPACE_NAME: ${{ secrets.SPACE_NAME }}
                  SPACE_ACCESS_KEY: ${{ secrets.SPACE_ACCESS_KEY }}
                  SPACE_SECRET_KEY: ${{ secrets.SPACE_SECRET_KEY }}
                  FILE_PATH: 'archive'
